<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Main Menu</title>
  <style>
    /* 主题变量：背景三色 + 强调双色（影响进度条&环形） */
    :root {
      --dur-bg: 700ms; --dur-accent: 420ms; --dur-text: 240ms;
      --c1:#e6eef5; --c2:#c9d6e3; --c3:#aeb9c6;
      --acc1:#90a4ae; --acc2:#607d8b; /* 强调渐变起止色 */
      --accent:#5a6b7a;               /* 文本强调色 */
      --text:#1b1f23; --muted:#5b6570;
      --card-bg:rgba(255,255,255,.55); --card-stroke:rgba(0,0,0,.06);
      --shadow:0 10px 30px rgba(15,23,42,.10);
      --dur:.45s;
    }
    @media(prefers-reduced-motion:reduce){ :root{ --dur:0s; } }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Noto Sans CJK SC","Microsoft Yahei",Helvetica,Arial;color:var(--text);position:relative;z-index:0;background:linear-gradient(160deg,var(--c1),var(--c2),var(--c3));background-size:200% 200%;animation:bg 18s ease-in-out infinite}
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:linear-gradient(160deg,var(--c1_next,var(--c1)),var(--c2_next,var(--c2)),var(--c3_next,var(--c3)));
      background-size:200% 200%;
      animation:bg 18s ease-in-out infinite;
      opacity:0;
      transition:opacity var(--dur-bg) ease;
      will-change:opacity;
    }
    body.bg-fading::before{opacity:1;}
    @keyframes bg{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
    @media(prefers-reduced-motion:reduce){body{animation:none}}

    .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr}
    header{position:relative;padding:16px 20px;display:flex;align-items:center;justify-content:center}
    header h1{margin:0;font-size:clamp(18px,2.6vw,28px);font-weight:800;letter-spacing:.4px}

    /* 右上角主题按钮 */
    #btn-theme{position:absolute;right:20px;top:12px;appearance:none;border:1px solid var(--card-stroke);background:rgba(255,255,255,.7);border-radius:12px;padding:8px 10px;cursor:pointer;box-shadow:var(--shadow);display:inline-flex;align-items:center;gap:8px;outline:none;-webkit-tap-highlight-color:transparent;user-select:none}
    #btn-theme:hover{filter:brightness(.98)}
    #btn-theme:focus{outline:none}
    #btn-theme:focus-visible{box-shadow:0 0 0 3px color-mix(in srgb, var(--acc2) 40%, transparent), var(--shadow)}
    .icon{width:18px;height:18px}

    .card{width:min(980px,92vw);margin:18px auto;background:var(--card-bg);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);border:1px solid var(--card-stroke);border-radius:20px;box-shadow:var(--shadow);padding:clamp(16px,2.4vw,28px)}

    .topline{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:10px;flex-wrap:nowrap;overflow:hidden}
    .range{color:var(--muted);font-size:14px;display:flex;flex-wrap:wrap;gap:10px 16px;flex:1 1 auto;min-width:0}
    .badge{flex:0 0 auto;display:inline-flex;align-items:center;justify-content:center;white-space:nowrap;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.06);color:var(--accent);border:1px solid var(--card-stroke)}

    .countdown{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:clamp(8px,2vw,16px);align-items:stretch;margin:8px 0 18px}
    .unit{background:rgba(255,255,255,.6);border:1px solid var(--card-stroke);border-radius:16px;padding:clamp(12px,2vw,18px);display:grid;grid-template-rows:1fr auto;place-items:center;min-height:110px}
    .num{display:flex;gap:.06em;line-height:1;font-variant-numeric:tabular-nums;font-feature-settings:"tnum" on;font-weight:800;font-size:clamp(28px,7vw,64px)}
    .digit{display:inline-block;min-width:.66em;text-align:center;will-change:transform,opacity}
    .label{color:var(--muted);font-size:13px;letter-spacing:.2px}

    .progress{margin:6px 0 2px}
    .bar{position:relative;height:14px;background:rgba(255,255,255,.65);border:1px solid var(--card-stroke);border-radius:999px;overflow:hidden}
    /* 进度条颜色跟随主题 */
    .fill{height:100%;width:100%;background:linear-gradient(90deg,var(--acc1),var(--acc2));transform-origin:left center;transform:scaleX(0);will-change:transform;transition:transform .6s ease}
    .meta{margin-top:8px;display:flex;flex-wrap:wrap;align-items:center;gap:10px 16px;font-size:13px;color:var(--muted)} .meta strong{color:var(--text)}

    .grid{margin-top:22px;display:grid;grid-template-columns:1fr;gap:clamp(14px,2.4vw,22px)}
    .panel{background:rgba(255,255,255,.6);border:1px solid var(--card-stroke);border-radius:16px;padding:clamp(12px,2vw,18px)}
    .ring-wrap{display:flex;align-items:center;justify-content:center;padding:8px 0}
    .ring{width:clamp(140px,28vw,240px);height:auto;display:block}
    .ring text{font-variant-numeric:tabular-nums;font-weight:700;fill:var(--accent)}

    /* 弹层 */
    .popover{position:fixed;z-index:20;min-width:240px;max-width:92vw;background:rgba(255,255,255,.96);border:1px solid var(--card-stroke);border-radius:12px;box-shadow:0 12px 40px rgba(15,23,42,.18);padding:10px;opacity:0;transform:scale(.96) translateY(-6px);pointer-events:none;visibility:hidden;transition:opacity .25s ease,transform .25s ease;-webkit-tap-highlight-color:transparent;user-select:none}
    .popover.open{opacity:1;transform:scale(1) translateY(0);pointer-events:auto;visibility:visible}
    .theme-list{display:grid;gap:10px}
    .item{display:flex;align-items:center;gap:10px;padding:6px;border-radius:12px;border:1px solid var(--card-stroke);background:rgba(255,255,255,.7);cursor:pointer;transition:background-color .25s ease,border-color .25s ease;-webkit-tap-highlight-color:transparent;user-select:none}
    .item:hover{filter:brightness(.98)}
    .dot{width:10px;height:10px;border-radius:50%;border:2px solid var(--card-stroke);background:transparent;margin-left:4px;transition:background-color .25s ease,border-color .25s ease}
    .item.selected .dot{background:var(--dot);border-color:var(--dot)}
    /* 预览条背景默认使用 --sw（每个条目在 JS 中单独设置，不随主题变化） */
    .preview{flex:1;height:40px;border-radius:999px;border:1px solid rgba(0,0,0,.06);background:var(--sw,linear-gradient(90deg,#e6eef5,#c9d6e3,#aeb9c6));display:flex;align-items:center;justify-content:center}
    .preview .name{font-size:12px;color:#2b3640}

    /* 主题过渡 */
    body,.card,.unit,.panel,.badge,.preview,.bar,.fill{transition:background .8s ease,background-color .6s ease,color .4s ease,border-color .5s ease}

    /* 按位数字跳动动画（时间由 --dur 控制） */
    @keyframes tick{0%{transform:translateY(20%);opacity:0}40%{transform:translateY(-6%)}100%{transform:translateY(0);opacity:1}}
    .digit.is-ticking{animation:tick var(--dur) ease}

    @media(max-width:720px){.countdown{grid-template-columns:repeat(2,minmax(0,1fr))}}
  
/* === 仅动画增强：进度条颜色 cross-fade + 文本统一成主题强调色 === */
.fill{ position:relative; }
.fill::before{
  content:""; position:absolute; inset:0;
  background:linear-gradient(90deg, var(--acc1_next, var(--acc1)), var(--acc2_next, var(--acc2)));
  opacity:0; transition: opacity var(--dur-accent) ease-in-out;
}
body.bg-fading .fill::before{ opacity:1; }

.meta{ color:var(--accent); transition: color var(--dur-text) ease-in-out; }
.meta strong{ color:inherit; }
#ringText{ fill:var(--accent); transition:fill var(--dur-text) ease-in-out; }
#g1s1, #g1s2{ transition: stop-color var(--dur-accent) ease-in-out; }

</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Main Menu</h1>
      <button id="btn-theme" title="主题/颜色">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 1 0-14 5 5 0 0 1 5 5 2 2 0 0 0 2 2h1a2 2 0 0 1 0 4h-1a7 7 0 0 1-7 3Z"/><circle cx="6.5" cy="12.5" r="1.5"/><circle cx="9.5" cy="7.5" r="1.5"/><circle cx="14.5" cy="7.5" r="1.5"/><circle cx="17.5" cy="12.5" r="1.5"/></svg>
        <span style="font-size:13px">主题</span>
      </button>
      <div class="popover" id="pop" role="listbox" aria-label="选择主题">
        <div class="theme-list" id="themeList"></div>
      </div>
    </header>

    <main class="card">
      <div class="topline">
        <div class="range">
          <div>开始：<strong id="startLabel"></strong></div>
          <div>结束：<strong id="endLabel"></strong></div>
        </div>
        <div class="badge" id="statusBadge">假期中</div>
      </div>

      <section class="countdown" aria-live="polite">
        <div class="unit"><div class="num" id="days">--</div><div class="label">天</div></div>
        <div class="unit"><div class="num" id="hours">--</div><div class="label">小时</div></div>
        <div class="unit"><div class="num" id="mins">--</div><div class="label">分钟</div></div>
        <div class="unit"><div class="num" id="secs">--</div><div class="label">秒</div></div>
      </section>

      <section class="progress">
        <div class="bar" aria-label="假期进度"><div class="fill" id="fill"></div></div>
        <div class="meta">
          <div>已过：<strong id="pct">0%</strong></div>
          <div>已用时：<strong id="elapsed">--</strong></div>
          <div>剩余：<strong id="remain">--</strong></div>
          <div>总时长：<strong id="total">--</strong></div>
        </div>
      </section>

      <section class="grid">
        <div class="panel">
          <h3 style="margin:0 0 10px;font-size:16px">假期流逝</h3>
          <div class="ring-wrap">
            <svg class="ring" viewBox="0 0 120 120" role="img" aria-label="假期流逝">
              <defs>
                <linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop id="g1s1" offset="0%" stop-color="var(--acc1)"/>
                  <stop id="g1s2" offset="100%" stop-color="var(--acc2)"/>
                </linearGradient>
              </defs>
              <circle cx="60" cy="60" r="52" stroke="rgba(0,0,0,.08)" stroke-width="12" fill="none" />
              <circle id="arc" cx="60" cy="60" r="52" stroke="url(#g1)" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="326.72" stroke-dashoffset="326.72" transform="rotate(-90 60 60)"/>
              <text id="ringText" x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="18">0%</text>
            </svg>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    'use strict';
    // —— 常量 ——
    const MS=1, SEC=1000*MS, MIN=60*SEC, HOUR=60*MIN, DAY=24*HOUR;
    const SHANGHAI_OFFSET_MIN = 8*60; // +08:00 固定
    const makeShanghaiDate=(y,m,d,hh=0,mm=0,ss=0)=> new Date(Date.UTC(y,m-1,d,hh-8,mm,ss));
    const pad=n=>String(n).padStart(2,'0');
    const fmtShanghai=(dt)=>{ const t=new Date(dt.getTime()+SHANGHAI_OFFSET_MIN*MIN); return `${t.getUTCFullYear()}-${pad(t.getUTCMonth()+1)}-${pad(t.getUTCDate())} ${pad(t.getUTCHours())}:${pad(t.getUTCMinutes())}:${pad(t.getUTCSeconds())}`; };

    // —— 区间（固定 2025-10-01 → 2025-10-08 23:59:59）——
    const state={
      start: makeShanghaiDate(2025,10,1,0,0,0),
      end:   makeShanghaiDate(2025,10,8,23,59,59),
      theme: localStorage.getItem('n-theme')||'mist-blue'
    };

    // —— DOM ——
    const dEl=document.getElementById('days'), hEl=document.getElementById('hours'), mEl=document.getElementById('mins'), sEl=document.getElementById('secs');
    const pctEl=document.getElementById('pct'), fillEl=document.getElementById('fill');
    const startLabel=document.getElementById('startLabel'), endLabel=document.getElementById('endLabel');
    const elapsedEl=document.getElementById('elapsed'), remainEl=document.getElementById('remain'), totalEl=document.getElementById('total');
    const badge=document.getElementById('statusBadge');
    const arc=document.getElementById('arc'), ringText=document.getElementById('ringText');
    const btnTheme=document.getElementById('btn-theme');
    const pop=document.getElementById('pop');
    const themeList=document.getElementById('themeList');

    // —— 主题清单（含强调色对）——
    const THEME_LIST=[
      {id:'mist-blue', name:'暮蓝雾霭',  bg:['#e6eef5','#c9d6e3','#aeb9c6'], acc:['#90a4ae','#607d8b'], accent:'#5a6b7a'},
      {id:'sage',      name:'松釉青灰',  bg:['#e8efe9','#cfdad2','#b5c3bb'], acc:['#9bb7a6','#6d8b74'], accent:'#59705f'},
      {id:'peach-tea', name:'雾粉橙茶',  bg:['#f6edea','#e7d9cf','#d9c6ba'], acc:['#e3a791','#c57c62'], accent:'#a3604a'},
      {id:'ink-hill',  name:'墨兰远山',  bg:['#eef1f0','#d5dbd9','#bcc6c2'], acc:['#9aa7a2','#6a7f78'], accent:'#556963'},
    ];

    function setVar(k,v){ document.documentElement.style.setProperty(k,v); }
    function applyTheme(id){
  const t = THEME_LIST.find(x=>x.id===id) || THEME_LIST[0];
  const [c1,c2,c3] = t.bg; const [a1,a2] = t.acc; const accent = t.accent || a2;

  // 背景 cross-fade（下一主题 → 淡入）
  setVar('--c1_next', c1); setVar('--c2_next', c2); setVar('--c3_next', c3);

  // 进度条颜色 cross-fade（下一主题 → 淡入）
  setVar('--acc1_next', a1); setVar('--acc2_next', a2);

  const body = document.body;
  body.classList.remove('bg-fading'); void body.offsetWidth; body.classList.add('bg-fading');

  // 文本强调色即时更新（由 CSS 做颜色过渡）
  setVar('--accent', accent);

  // 环形渐变 stop 颜色过渡（SVG 内联）
  const s1 = document.getElementById('g1s1'), s2 = document.getElementById('g1s2');
  if(s1 && s2){ s1.setAttribute('stop-color', a1); s2.setAttribute('stop-color', a2); }

  // 持续时间（默认 700ms）
  const durStr = getComputedStyle(document.documentElement).getPropertyValue('--dur-bg').trim();
  const dur = durStr.endsWith('ms') ? parseFloat(durStr) : durStr.endsWith('s') ? parseFloat(durStr)*1000 : 700;
  clearTimeout(window.__bgFadeTimer__);

  window.__bgFadeTimer__ = setTimeout(()=>{
    // 提交：把 next 写回正式变量；清空 next；结束淡入类
    setVar('--c1', c1); setVar('--c2', c2); setVar('--c3', c3);
    setVar('--acc1', a1); setVar('--acc2', a2);
    setVar('--c1_next',''); setVar('--c2_next',''); setVar('--c3_next','');
    setVar('--acc1_next',''); setVar('--acc2_next','');
    body.classList.remove('bg-fading');
  }, dur);

  state.theme = t.id; localStorage.setItem('n-theme', t.id);
  document.documentElement.dataset.theme = t.id;
  document.querySelectorAll('.item').forEach(it=> it.classList.toggle('selected', it.dataset.id===t.id));
}

    function mountThemeList(){
      themeList.innerHTML='';
      THEME_LIST.forEach(t=>{
        const li=document.createElement('div'); li.className='item'; li.dataset.id=t.id; li.setAttribute('role','option');
        li.style.setProperty('--dot', t.acc[1]);
        const dot=document.createElement('div'); dot.className='dot';
        const prev=document.createElement('div'); prev.className='preview';
        // 固定该项的预览背景，不随主题切换
        prev.style.setProperty('--sw', `linear-gradient(90deg, ${t.bg[0]}, ${t.bg[1]}, ${t.bg[2]})`);
        const name=document.createElement('span'); name.className='name'; name.textContent=t.name; prev.appendChild(name);
        li.append(dot, prev);
        li.addEventListener('click', ()=>{ applyTheme(t.id); pop.classList.remove('open'); btnTheme.setAttribute('aria-expanded','false'); });
        themeList.appendChild(li);
      });
      applyTheme(localStorage.getItem('n-theme')||state.theme);
    }

    // 弹层定位与交互
    btnTheme.setAttribute('aria-haspopup','listbox');
    btnTheme.setAttribute('aria-controls','pop');
    btnTheme.addEventListener('click', (e)=>{
      e.stopPropagation();
      const willOpen=!pop.classList.contains('open');
      if(willOpen){ positionPop(); requestAnimationFrame(()=>{ pop.classList.add('open'); btnTheme.setAttribute('aria-expanded','true'); }); }
      else { pop.classList.remove('open'); btnTheme.setAttribute('aria-expanded','false'); }
    });
    function positionPop(){ const r=btnTheme.getBoundingClientRect(); const x=Math.max(8, r.right - (pop.offsetWidth||240)); const y=r.bottom + 10; pop.style.left=x+'px'; pop.style.top=y+'px'; }
    window.addEventListener('resize', ()=>{ if(pop.classList.contains('open')) positionPop(); });
    document.addEventListener('pointerdown', (e)=>{ if(!pop.contains(e.target) && !btnTheme.contains(e.target)) { pop.classList.remove('open'); btnTheme.setAttribute('aria-expanded','false'); } });

    // —— 工具 ——
    const fmtHM=ms=>{ const d=Math.floor(ms/DAY); ms-=d*DAY; const h=Math.floor(ms/HOUR); ms-=h*HOUR; const m=Math.floor(ms/MIN); ms-=m*MIN; const s=Math.floor(ms/SEC); return {d,h,m,s}; };
    const human=ms=>{ const {d,h,m,s}=fmtHM(Math.max(0,ms)); const p=[]; if(d) p.push(`${d}天`); if(h) p.push(`${h}小时`); if(m) p.push(`${m}分钟`); if(!d&&!h) p.push(`${s}秒`); return p.join(' '); };
    const clamp01=x=>Math.min(1,Math.max(0,x));

    // —— 按位数字 ——
    const prev={d:"",h:"",m:"",s:""};
    function ensureDigits(el, count){ if(el.children.length!==count){ el.innerHTML=""; for(let i=0;i<count;i++){ const sp=document.createElement('span'); sp.className='digit'; sp.textContent='-'; el.appendChild(sp); } } }
    function setDigits(el, key, value, width=2){
      const str = String(Math.max(0,value)).padStart(width,'0');
      ensureDigits(el, str.length);
      for(let i=0;i<str.length;i++){
        const ch=str[i]; const span=el.children[i];
        if(prev[key].charAt(i)!==ch){
          span.classList.remove('is-ticking');
          void span.offsetWidth; // 强制重排，确保能再次触发 animation
          span.textContent=ch;
          span.classList.add('is-ticking');
        } else if(!span.textContent){ span.textContent=ch; }
      }
      prev[key]=str;
    }

    // —— 更新 ——
    const R=52; const ringLen=2*Math.PI*R; arc.setAttribute('stroke-dasharray', ringLen.toFixed(2));
    function update(){
      const now=Date.now();
      const total=state.end-state.start; const elapsed=now-state.start; const remain=state.end-now;

      const shown = fmtHM(Math.max(0,remain));
      setDigits(dEl,'d',shown.d,2);
      setDigits(hEl,'h',shown.h,2);
      setDigits(mEl,'m',shown.m,2);
      setDigits(sEl,'s',shown.s,2);

      const p=clamp01(elapsed/total);
      const pct=Math.round(p*1000)/10; // 用于文本
      fillEl.style.transform = `scaleX(${p})`; // transform 驱动避免闪烁
      pctEl.textContent=pct.toFixed(1)+'%';

      const offset=ringLen*(1-p); arc.style.strokeDashoffset=String(offset); ringText.textContent=pct.toFixed(0)+'%';

      if(!startLabel.textContent) startLabel.textContent=fmtShanghai(state.start);
      if(!endLabel.textContent) endLabel.textContent=fmtShanghai(state.end);
      elapsedEl.textContent=elapsed<0?'未开始':human(elapsed); remainEl.textContent=remain<0?'已结束':human(remain); totalEl.textContent=human(total);
      badge.textContent = elapsed<0? '未开始' : remain<0? '已结束·收心' : '假期中';
    }

    // —— 启动 ——
    (function(){
      mountThemeList(); ensureDigits(dEl,2); ensureDigits(hEl,2); ensureDigits(mEl,2); ensureDigits(sEl,2);
      update();
      const kick = 1000 - (Date.now() % 1000);
      setTimeout(()=>{ update(); setInterval(update,1000); }, kick);
    })();
  </script>
</body>
</html>
